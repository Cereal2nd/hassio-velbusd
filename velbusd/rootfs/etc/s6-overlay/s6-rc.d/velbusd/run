#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Runs velbusd
# ==============================================================================

bashio::log.info "Building configfile..."
jq -n '{
  "ntp": {
    "enabled": $ntp,
    "synctime": "03:00"
  },
  "connections": [
    {
      "host": "0.0.0.0",
      "port": $port,
      "relay": true,
      "ssl": false,
      "cert": "",
      "pk": "",
      "auth": $auth,
      "auth_key": $auth_key
    }
  ],
  "serial": {
    "autodiscover": false,
    "port": $velbus
  },
  "logging": {
    "type": $logging,
    "output": "stream"
  }
}' \
  --arg ntp $(bashio::config 'ntp') \
  --arg logging $(bashio::config 'logging') \
  --arg velbus $(bashio::config 'velbus') \
  --arg port $(bashio::addon.port) \
  --arg auth $(bashio::config 'auth') \
  --arg auth_key $(bashio::config 'auth_key') \
> /settings.json


# starting
bashio::log.info "Starting VelbusD..."
exec python3 -m velbustcp --settings /settings.json
